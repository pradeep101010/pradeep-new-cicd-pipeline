trigger: none
pr: none

stages:
- stage: Deploy
  displayName: CD - Deploy Terraform Plan

  jobs:
  - deployment: ApplyPlan
    displayName: Apply Terraform Plan
    environment: 'dev-env'
    pool:
      name: 'pradeep-pool'   # your self-hosted agent
    strategy:
      runOnce:
        deploy:
          steps:

          # Install Terraform
          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '1.5.7'

          # Download terraform folder & plan artifacts from CI
          - task: DownloadPipelineArtifact@2
            displayName: 'Download terraform folder'
            inputs:
              buildType: 'specific'
              project: '$(System.TeamProjectId)'
              pipeline: 'pradeep-new-cicd-pipeline'
              runVersion: 'specific'
              runId: '$(resources.pipeline.ciPipeline.runId)'
              artifact: 'terraform'
              path: '$(Pipeline.Workspace)/terraform'

          - download: current
            artifact: tfplan
            displayName: 'Download tfplan binary artifact'

          - download: current
            artifact: tfplan_json
            displayName: 'Download tfplan JSON artifact'

          # Set Managed Identity environment variables
          - script: |
              echo "Exporting MSI environment variables for Terraform..."
              export ARM_USE_MSI=true
              export ARM_MSI_CLIENT_ID=eca641d4-4893-44d1-9958-99febd55485b
              export ARM_SUBSCRIPTION_ID=145ccdc1-6c51-4e45-a04e-21bdea03d170
              export ARM_TENANT_ID=2a731c61-a2b2-4661-8409-5b861cf40d0c

              # Export TF_VARs
              export TF_VAR_resource_group_name="pradeep-rg"
              export TF_VAR_location="eastus"
              export TF_VAR_app_service_plan_name="pradeep-plan"
              export TF_VAR_app_service_plan_tier="Standard"
              export TF_VAR_app_service_plan_size="S1"
              export TF_VAR_app_service_name="pradeep-app"
              export TF_VAR_linux_fx_version="DOTNETCORE|7.0"

              echo 'tags = {"env":"dev","owner":"pradeep"}' > $(Pipeline.Workspace)/terraform/ci.tfvars
            displayName: 'Set environment variables (MSI + TF_VARs)'
            env:
              TF_IN_AUTOMATION: '1'

          # Fix permissions for provider binaries
          - script: |
              echo "Fixing Terraform provider permissions..."
              chmod -R +x $(Pipeline.Workspace)/terraform/.terraform/providers/
            displayName: 'Fix Terraform provider permissions'

          # Terraform init & apply using MSI
          - script: |
              cd $(Pipeline.Workspace)/terraform

              echo "Initializing Terraform..."
              terraform init -input=false -upgrade

              echo "Applying Terraform plan..."
              terraform apply -input=false -var-file=ci.tfvars tfplan.binary
            displayName: 'Terraform Apply via MSI'
            env:
              TF_IN_AUTOMATION: '1'
              ARM_USE_MSI: true
              ARM_MSI_CLIENT_ID: eca641d4-4893-44d1-9958-99febd55485b
              ARM_SUBSCRIPTION_ID: 145ccdc1-6c51-4e45-a04e-21bdea03d170
              ARM_TENANT_ID: 2a731c61-a2b2-4661-8409-5b861cf40d0c
