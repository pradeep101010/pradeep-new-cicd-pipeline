trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

variables:
  # Hardcoded values
  environment: 'dev'
  resource_group_name: 'pradeep-rg'
  location: 'eastus'
  app_service_plan_name: 'pradeep-plan'
  app_service_plan_tier: 'Standard'
  app_service_plan_size: 'S1'
  app_service_name: 'pradeep-app'
  linux_fx_version: 'DOTNETCORE|7.0'
  tags: '{"env":"dev","owner":"pradeep"}'

stages:
- stage: Terraform_CI
  displayName: CI - Terraform
  jobs:
  - job: ValidateAndPlan
    displayName: Validate & Plan
    pool:
      vmImage: 'ubuntu-latest'
    steps:

    # Install Terraform manually with unzip fix
    - script: |
        echo "Installing Terraform 1.5.7..."
        sudo apt-get update && sudo apt-get install -y unzip curl

        # Clean up any previous Terraform files
        rm -f terraform
        rm -f terraform_1.5.7_linux_amd64.zip

        # Download and extract only the binary
        curl -LO https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_linux_amd64.zip
        unzip -o -j terraform_1.5.7_linux_amd64.zip -d .
        sudo mv terraform /usr/local/bin/
        terraform version
      displayName: 'Install Terraform manually'

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'
      displayName: 'Ensure Python (for jq if needed)'

    - script: |
        export TF_VAR_resource_group_name="pradeep-rg"
        export TF_VAR_location="eastus"
        export TF_VAR_app_service_plan_name="pradeep-plan"
        export TF_VAR_app_service_plan_tier="Standard"
        export TF_VAR_app_service_plan_size="S1"
        export TF_VAR_app_service_name="pradeep-app"
        export TF_VAR_linux_fx_version="DOTNETCORE|7.0"

        echo 'tags = {"env":"dev","owner":"pradeep"}' > terraform/ci.tfvars
      displayName: 'Prepare TF_VARs'

    - task: AzureCLI@2
      displayName: 'Authenticate to Azure'
      inputs:
        azureSubscription: 'pradeep-last-sc'   # Hardcoded service connection
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az account show
      env:
        AZURE_DEVOPS_EXT_TELEMETRY_OPTOUT: "1"

    - script: |
        set -euo pipefail
        cd terraform

        terraform init -input=false
        terraform fmt -check || (terraform fmt && echo "Reformatted files")

        terraform validate -json > validate.json || true
        ERR_COUNT=$(jq '[.diagnostics[] | select(.severity=="error")] | length' validate.json)
        WARN_COUNT=$(jq '[.diagnostics[] | select(.severity=="warning")] | length' validate.json)

        echo "Terraform validate: errors=${ERR_COUNT} warnings=${WARN_COUNT}"

        if [ "$ERR_COUNT" -gt 0 ]; then
          cat validate.json
          exit 1
        fi

        if [ "${environment}" = "prod" ] && [ "$WARN_COUNT" -gt 0 ]; then
          echo "Strict validation in prod: warnings are not allowed"
          cat validate.json
          exit 1
        fi

        echo "Validation complete"
      displayName: 'terraform validate (env-specific behavior)'
      env:
        TF_IN_AUTOMATION: "1"

    - script: |
        cd terraform
        terraform plan -input=false -out=tfplan.binary -var-file=ci.tfvars 2>&1 | tee plan.log
        terraform show -json tfplan.binary > tfplan.json
      displayName: 'terraform plan and produce JSON plan'
      env:
        TF_IN_AUTOMATION: "1"

    - publish: terraform/tfplan.binary
      artifact: tfplan

    - publish: terraform/tfplan.json
      artifact: tfplan_json

    - publish: terraform/plan.log
      artifact: planlog
