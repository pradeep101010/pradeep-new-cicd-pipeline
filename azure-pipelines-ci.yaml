name: ci-$(Date:yyyyMMdd)-$(Rev:.r)
trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

stages:
- stage: Terraform_CI
  displayName: CI - Terraform
  jobs:
  - job: ValidateAndPlan
    displayName: Validate & Plan
    pool:
      name: 'pradeep-pool'   # Use your self-hosted agent
    variables:
      environment: "dev"
      TF_VAR_resource_group_name: "pradeep-auto-rg"
      TF_VAR_location: "eastus"
      TF_VAR_app_service_plan_name: "pradeep-plan"
      TF_VAR_app_service_plan_tier: "Standard"
      TF_VAR_app_service_plan_size: "S1"
      TF_VAR_app_service_name: "pradeep-app"
      TF_VAR_linux_fx_version: "DOTNETCORE|7.0"

    steps:
    ############################################
    # Install OS Dependencies for Terraform
    ############################################
    - task: CmdLine@2
      displayName: 'Install required tools'
      inputs:
        script: |
          sudo apt-get update
          sudo apt-get install -y unzip jq

    ############################################
    # Install Terraform
    ############################################
    - task: TerraformInstaller@1
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: '1.5.7'

    ############################################
    # Set Managed Identity Environment Variables
    ############################################
    - script: |
        echo "Setting Terraform Azure MSI environment variables..."
        export ARM_USE_MSI=true
        export ARM_MSI_CLIENT_ID=eca641d4-4893-44d1-9958-99febd55485b
        export ARM_SUBSCRIPTION_ID=145ccdc1-6c51-4e45-a04e-21bdea03d170
        export ARM_TENANT_ID=2a731c61-a2b2-4661-8409-5b861cf40d0c
        env | grep ARM_
      displayName: 'Set Terraform MSI environment variables'

    ############################################
    # Create TFVARs file
    ############################################
    - script: |
        echo 'tags = {"env":"dev","owner":"pradeep"}' > terraform/ci.tfvars
      displayName: 'Create ci.tfvars'

    ############################################
    # Terraform Validate
    ############################################
    - script: |
        set -euo pipefail
        cd terraform

        terraform init -input=false
        terraform fmt -check || terraform fmt

        terraform validate -json > validate.json || true

        ERR_COUNT=$(jq '[.diagnostics[] | select(.severity=="error")] | length' validate.json)
        WARN_COUNT=$(jq '[.diagnostics[] | select(.severity=="warning")] | length' validate.json)

        echo "Terraform validate: errors=${ERR_COUNT} warnings=${WARN_COUNT}"

        if [ "$ERR_COUNT" -gt 0 ]; then exit 1; fi
        if [ "$(environment)" = "prod" ] && [ "$WARN_COUNT" -gt 0 ]; then exit 1; fi

        echo "Validation complete"
      displayName: 'terraform validate'
      env:
        TF_IN_AUTOMATION: "1"
        TF_VAR_resource_group_name: $(TF_VAR_resource_group_name)
        TF_VAR_location: $(TF_VAR_location)
        TF_VAR_app_service_plan_name: $(TF_VAR_app_service_plan_name)
        TF_VAR_app_service_plan_tier: $(TF_VAR_app_service_plan_tier)
        TF_VAR_app_service_plan_size: $(TF_VAR_app_service_plan_size)
        TF_VAR_app_service_name: $(TF_VAR_app_service_name)
        TF_VAR_linux_fx_version: $(TF_VAR_linux_fx_version)
        ARM_USE_MSI: true
        ARM_MSI_CLIENT_ID: eca641d4-4893-44d1-9958-99febd55485b
        ARM_SUBSCRIPTION_ID: 145ccdc1-6c51-4e45-a04e-21bdea03d170
        ARM_TENANT_ID: 2a731c61-a2b2-4661-8409-5b861cf40d0c

    ############################################
    # Terraform Plan
    ############################################
    - script: |
        cd terraform

        terraform plan \
          -input=false \
          -out=tfplan.binary \
          -var-file=ci.tfvars \
          2>&1 | tee plan.log

        terraform show -json tfplan.binary > tfplan.json
      displayName: 'terraform plan'
      env:
        TF_IN_AUTOMATION: "1"
        TF_VAR_resource_group_name: $(TF_VAR_resource_group_name)
        TF_VAR_location: $(TF_VAR_location)
        TF_VAR_app_service_plan_name: $(TF_VAR_app_service_plan_name)
        TF_VAR_app_service_plan_tier: $(TF_VAR_app_service_plan_tier)
        TF_VAR_app_service_plan_size: $(TF_VAR_app_service_plan_size)
        TF_VAR_app_service_name: $(TF_VAR_app_service_name)
        TF_VAR_linux_fx_version: $(TF_VAR_linux_fx_version)
        ARM_USE_MSI: true
        ARM_MSI_CLIENT_ID: eca641d4-4893-44d1-9958-99febd55485b
        ARM_SUBSCRIPTION_ID: 145ccdc1-6c51-4e45-a04e-21bdea03d170
        ARM_TENANT_ID: 2a731c61-a2b2-4661-8409-5b861cf40d0c

    ############################################
    # Publish artifacts
    ############################################
    - publish: terraform
      artifact: terraform

    - publish: terraform/tfplan.binary
      artifact: tfplan

    - publish: terraform/tfplan.json
      artifact: tfplan_json

    - publish: terraform/plan.log
      artifact: planlog
